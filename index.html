<!DOCTYPE html>
<html lang="en">
<head>
    <title>African cropland and landcover Openlayer Web Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.3.0/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.3.0/ol.css">
    <script src="https://unpkg.com/geotiff@2.1.3/dist/geotiff.bundle.js"></script>
    <script src="https://unpkg.com/ol-pmtiles@0.3.0/dist/olpmtiles.js"></script>
    <script src="https://cdn.rawgit.com/seikichi/tiff.js/master/tiff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol-ext@4.0.11/dist/ol-ext.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol-ext@4.0.11/dist/ol-ext.min.css">
    <script src="https://cdn.jsdelivr.net/npm/geotiff"></script>
    <script>console.log(GeoTIFF);</script>
    
    <style>
        body, #map {
            height: 100vh;
            margin: 0;
        }
        
        .checkboxes {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: row-reverse;
            gap: 20px;
        }
        .checkboxes .country {
            position: relative;
            background-color: white;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .hidden-checkboxes {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            flex-direction: column;
            gap: 5px;
            padding: 5px;
        }
        .checkboxes .country:hover .hidden-checkboxes {
            display: flex;
        }
        .hidden-checkboxes label {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background-color: #f9f9f9;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .hidden-checkboxes input {
            margin-top: 5px;
        }
        
        img, video, canvas {
            overflow: hidden !important; /* to ensure overflow is not set to visible */
            display: block;   /* to ensures that the elements behave more predictably in terms of spacing */
            max-width: 100%;  /* to ensure the elements do not overflow the parent container */
            max-height: 100%; /* to ensure the elements do not overflow the parent container */
            box-sizing: border-box; /* to include padding and border in the element's total width and height */
        }
        
    </style>
</head>
<body>
    <div id="map"></div>
    <script type="text/javascript">
        const hybridBaseLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=0rXt9evmwC5e2EW3sauy',
                attributions: '© MapTiler © OpenStreetMap contributors',
                maxZoom: 20
            })
        });

        const pmTilesSources = {
            Congo: 'https://mappingafrica.s3.us-west-2.amazonaws.com/croplands/pmtiles/congo_2022_v1.pmtiles',
            Zambia: 'https://mappingafrica.s3.us-west-2.amazonaws.com/croplands/pmtiles/zambia_2022_v1.pmtiles',
            Ghana: 'https://mappingafrica.s3.us-west-2.amazonaws.com/croplands/pmtiles/ghana_2018_v1.pmtiles'
        };

        const tiffSources = {
            Tanzania: 'https://mappingafrica.s3.us-west-2.amazonaws.com/landcover/tanzania_2019_cog.tif',
            Ghana: 'https://mappingafrica.s3.us-west-2.amazonaws.com/croplands/cogs/crop_fractions_ghana_2018-2023.tif'
        };

        const countryExtents = {
            Congo: ol.proj.transformExtent([11.093, -5.037, 19.457, 5.399], 'EPSG:4326', 'EPSG:3857'),
            Zambia: ol.proj.transformExtent([21.999, -18.076, 33.485, -8.224], 'EPSG:4326', 'EPSG:3857'),
            Tanzania: ol.proj.transformExtent([29.321, -11.741, 40.449, -0.984], 'EPSG:4326', 'EPSG:3857'),
            Ghana: ol.proj.transformExtent([-3.255, 4.541, 1.202, 11.174], 'EPSG:4326', 'EPSG:3857')
        };

        let initialExtent = ol.extent.createEmpty();
        Object.values(countryExtents).forEach(extent => {
            ol.extent.extend(initialExtent, extent);
        });

        const map = new ol.Map({
            layers: [hybridBaseLayer],
            target: 'map',
            view: new ol.View({
                center: ol.extent.getCenter(initialExtent),
                zoom: 5
            })
        });

        map.getView().fit(initialExtent, { duration: 1000 });

        let layers = {};
        let selectedCountries = new Set();
        let countryLayers = {};

        function updateZoom() {
            if (selectedCountries.size > 0) {
                let extent = ol.extent.createEmpty();
                selectedCountries.forEach(country => {
                    ol.extent.extend(extent, countryExtents[country]);
                });
                map.getView().fit(extent, { duration: 1000 });
            } else {
                map.getView().setCenter(ol.extent.getCenter(initialExtent));
                map.getView().setZoom(3);
            }
        }

        async function addLayer(country, layerType) {
            const sourceUrl = layerType === 'pmtiles' ? pmTilesSources[country] : tiffSources[country];
            console.log(`Adding ${layerType} layer for ${country} with URL: ${sourceUrl}`);
            try {
                if (layerType === 'pmtiles') {
                    layers[`${country}-${layerType}`] = new ol.layer.VectorTile({
                        declutter: true,
                        source: new olpmtiles.PMTilesVectorSource({
                            url: sourceUrl
                        }),
                        style: new ol.style.Style({
                            stroke: new ol.style.Stroke({
                                color: 'lightblue',
                                width: 1,
                            }),
                            fill: new ol.style.Fill({
                                color: 'rgba(0,0,0,0)',
                            })
                        })
                    });
                } else {
                    layers[`${country}-${layerType}`] = new ol.layer.Tile({
                        source: new ol.source.GeoTIFF({
                            sources: [{
                                url: sourceUrl,
                                nodata: 0,
                                crossOrigin: 'anonymous' // Ensuring CORS headers are set
                            }],
                        }),
                    });
                }
                console.log(`${layerType} layer for ${country} created.`);
                map.addLayer(layers[`${country}-${layerType}`]);
                console.log(`${layerType} layer for ${country} added to map.`);
                selectedCountries.add(country);
                if (!countryLayers[country]) {
                    countryLayers[country] = new Set();
                }
                countryLayers[country].add(layerType);
                updateZoom();
            } catch (error) {
                console.error(`Error creating ${layerType} layer for ${country}:`, error);
            }
        }

        function removeLayer(country, layerType) {
            if (layers[`${country}-${layerType}`]) {
                map.removeLayer(layers[`${country}-${layerType}`]);
                delete layers[`${country}-${layerType}`];
                if (countryLayers[country]) {
                    countryLayers[country].delete(layerType);
                    if (countryLayers[country].size === 0) {
                        selectedCountries.delete(country);
                    }
                }
                updateZoom();
            }
        }

        function createCheckbox(id, label, country, layerType) {
            const checkboxLabel = document.createElement('label');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = id;
            checkbox.checked = true; // Initialize checkbox as checked
            checkbox.onchange = (event) => {
                if (event.target.checked) {
                    addLayer(country, layerType);
                } else {
                    removeLayer(country, layerType);
                }
            };
            checkboxLabel.appendChild(document.createTextNode(label));
            checkboxLabel.appendChild(checkbox);
            return checkboxLabel;
        }

        function createCountryCheckboxes(country) {
            const countryDiv = document.createElement('div');
            countryDiv.className = 'country';
            countryDiv.appendChild(document.createTextNode(country));

            const hiddenDiv = document.createElement('div');
            hiddenDiv.className = 'hidden-checkboxes';

            if (pmTilesSources[country]) {
                hiddenDiv.appendChild(createCheckbox(`${country}-pmtiles`, 'Field Boundary', country, 'pmtiles'));
            }
            if (tiffSources[country]) {
                hiddenDiv.appendChild(createCheckbox(`${country}-tiff`, 'Land Cover', country, 'tiff'));
            }

            if (hiddenDiv.children.length > 0) {
                countryDiv.appendChild(hiddenDiv);
                return countryDiv;
            }
            return null;
        }

        const checkboxesContainer = document.createElement('div');
        checkboxesContainer.className = 'checkboxes';

        ['Congo', 'Zambia', 'Tanzania', 'Ghana'].forEach(country => {
            const countryCheckboxes = createCountryCheckboxes(country);
            if (countryCheckboxes) {
                checkboxesContainer.appendChild(countryCheckboxes);
            }
        });

        document.getElementById('map').appendChild(checkboxesContainer);

        // initializing map with checking all layers
        ['Congo', 'Zambia', 'Tanzania', 'Ghana'].forEach(country => {
            if (pmTilesSources[country]) {
                addLayer(country, 'pmtiles');
            }
            if (tiffSources[country]) {
                addLayer(country, 'tiff');
            }
        });

    </script>
</body>
</html>
